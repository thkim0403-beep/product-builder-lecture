<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-900 text-white p-10">

    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-yellow-400">‚ö° Quiz Factory (Admin)</h1>
        
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-4">
            <!-- Bulk Generation Settings -->
            <div class="mb-4">
                 <div class="bg-gray-700 p-4 rounded-lg mb-4">
                    <h4 class="text-sm font-bold text-gray-300 mb-2">‚ö° ULTIMATE FULL AUTO MODE</h4>
                    <p class="text-xs text-gray-400 mb-2">Generates questions for ALL topics, ALL languages (KO, EN), and ALL difficulties (Easy, Medium, Hard) automatically.</p>
                 </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Batch Loops</label>
                    <input type="number" id="loops" value="1" min="1" max="5" class="w-full bg-gray-700 p-2 rounded border border-gray-600">
                    <p class="text-xs text-yellow-500 mt-1">‚ö†Ô∏è Warning: 1 Loop = 36 API Calls (6 Topics x 2 Langs x 3 Diff). High quality with AI QA.</p>
                </div>
            </div>

            <!-- Action -->
            <button id="generate-btn" class="w-full bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                üî• GENERATE EVERYTHING (V2)
            </button>
            
            <!-- Hidden inputs for compatibility if needed, or just removed logic -->

            <!-- Logs -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Real-time Logs</h3>
                <div id="logs" class="bg-black p-4 rounded h-96 overflow-y-auto font-mono text-xs text-green-400 border border-gray-700 shadow-inner">
                    Ready to generate ALL quizzes (V2)...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (Config & Init Code remains same) ...
        const firebaseConfig = {
            apiKey: "AIzaSyAO4HT33-jzFI0VKvxGTbrAwCNtNUcpQYY",
            authDomain: "ai-quiz-f8680.firebaseapp.com",
            projectId: "ai-quiz-f8680",
            databaseURL: "https://ai-quiz-f8680-default-rtdb.firebaseio.com",
            storageBucket: "ai-quiz-f8680.firebasestorage.app",
            messagingSenderId: "305663762906",
            appId: "1:305663762906:web:e0f9033fff4f4b1d4660e3"
        };

        const btn = document.getElementById('generate-btn');
        const logBox = document.getElementById('logs');
        let db;

        const TOPICS = ["history", "science", "general", "sports", "movies", "geography"];
        const LANGS = ["ko", "en"];
        const DIFFICULTIES = ["Easy", "Medium", "Hard"]; // Full coverage!

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logBox.prepend(div);
        }

        // ... (Init logic remains same) ...
        window.addEventListener('DOMContentLoaded', () => {
             // ...
            log("‚è≥ Initializing Admin Tool...");
            try {
                if (!window.firebase) throw new Error("Firebase SDK not loaded.");
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                log("‚úÖ Ready for ULTIMATE FULL AUTO generation.");
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } catch (e) {
                log(`‚ùå Init Error: ${e.message}`);
                btn.innerText = "‚ùå System Error";
            }
        });

        btn.onclick = async () => {
            if (!db) return alert("Firebase not connected!");
            
            const loops = parseInt(document.getElementById('loops').value);
            const totalCalls = loops * TOPICS.length * LANGS.length * DIFFICULTIES.length;

            if(!confirm(`ULTIMATE MODE: This will make ${totalCalls} API calls. This is a massive operation. Continue?`)) return;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerText = "‚è≥ FULL AUTO WORKING... DO NOT CLOSE";

            try {
                let totalSaved = 0;
                let progress = 0;

                // Helper for 429 Retries
                const fetchWithRetry = async (payload, retries = 3, delay = 10000) => {
                    try {
                        const response = await fetch('/api/generate-quiz', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status == 429) {
                            if (retries > 0) {
                                log(`   ‚ö†Ô∏è Rate Limit Hit! Cooling down for ${delay/1000}s...`);
                                await new Promise(r => setTimeout(r, delay));
                                return fetchWithRetry(payload, retries - 1, delay * 2); // Exponential backoff
                            }
                            throw new Error("API Error 429 (Too Many Requests) - Skipped");
                        }

                        if (!response.ok) throw new Error(`API Error ${response.status}`);
                        return await response.json();
                    } catch (e) {
                        throw e;
                    }
                };

                for (let i = 0; i < loops; i++) {
                    log(`--- Loop ${i+1}/${loops} ---`);
                    
                    for (const lang of LANGS) {
                        for (const topic of TOPICS) {
                            for (const difficulty of DIFFICULTIES) {
                                progress++;
                                
                                log(`[${progress}/${totalCalls}] üîÑ ${lang.toUpperCase()} | ${topic} | ${difficulty} ...`);

                                try {
                                    const questions = await fetchWithRetry({ topic, difficulty, lang, bypassCache: true });
                                    
                                    const batch = db.batch();
                                    let batchCount = 0;
                                    questions.forEach(q => {
                                        // Include difficulty in ID to prevent collision between Easy/Hard
                                        const safeId = `${lang}_${topic}_${difficulty}_` + q.question.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, "").substring(0, 30);
                                        const docRef = db.collection('quiz_bank').doc(safeId);
                                        batch.set(docRef, { ...q, topic, difficulty, lang, createdAt: new Date(), source: 'ultimate-auto' });
                                        batchCount++;
                                    });
                                    await batch.commit();
                                    totalSaved += batchCount;
                                    log(`   ‚úÖ Saved ${batchCount} items.`);

                                } catch (err) {
                                    log(`   ‚ùå Failed: ${err.message}`);
                                }
                                
                                // Politeness delay (increased to 6s for OpenTrivia stability)
                                await new Promise(r => setTimeout(r, 6000));
                            }
                        }
                    }
                }

                log(`üéâ ALL DONE! Total ${totalSaved} quality questions added.`);
                alert(`Success! Your database is now populated with ${totalSaved} verified questions.`);

            } catch (e) {
                log(`‚ùå FATAL ERROR: ${e.message}`);
                alert(`Error: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerText = "üî• GENERATE EVERYTHING";
            }
        };
    </script>
</body>
</html>